<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver App</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .section {
            display: none;
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .section.active {
            display: block;
        }
        h2 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        form div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #337ab7;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #286090;
        }
        .ride-list, .driver-list {
            list-style-type: none;
            padding: 0;
        }
        .ride-list li, .driver-list li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .leaderboard-list {
            list-style-type: none;
            padding: 0;
        }
        .leaderboard-list li {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        .driver-info {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .driver-info-details {
            flex-grow: 1;
        }
        .driver-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ccc;
        }
        .vehicle-pictures {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .vehicle-pictures img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #eee;
        }
        .btn-link {
            background: none;
            color: #337ab7;
            border: none;
            padding: 0;
            cursor: pointer;
            text-decoration: underline;
        }
        .image-upload-container {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-section" class="section active">
            <h2>Login</h2>
            <form id="login-form">
                <div>
                    <label for="login-id">Driver ID / Admin:</label>
                    <input type="text" id="login-id" required>
                </div>
                <div>
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <div id="driver-dashboard-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Welcome, <span id="driver-name-display"></span></h2>
                <button onclick="logout()">Logout</button>
            </div>
            
            <div id="driver-info" class="driver-info">
                <img id="driver-picture-display" class="driver-picture" src="" alt="Driver Picture">
                <div class="driver-info-details">
                    <p><strong>WhatsApp Phone:</strong> <span id="driver-phone-display"></span></p>
                    <p><strong>Vehicle:</strong> <span id="vehicle-type-color-display"></span></p>
                    <p><strong>License Plate:</strong> <span id="license-plate-display"></span></p>
                    <p><strong>License Number:</strong> <span id="license-number-display"></span></p>
                    <p><strong>Insurance Number:</strong> <span id="insurance-number-display"></span></p>
                    <div class="vehicle-pictures">
                        <img id="vehicle-picture-display" src="" alt="Vehicle Picture">
                        <img id="insurance-picture-display" src="" alt="Insurance Picture">
                    </div>
                </div>
            </div>

            <h3>Notes from Admin:</h3>
            <p id="driver-notes"></p>

            <h3>My Commissions</h3>
            <p><strong>Amount Due:</strong> <span id="driver-commission-amount">$0.00</span></p>
            <p><strong>Due Date:</strong> <span id="driver-commission-due-date">N/A</span></p>

            <h3>Record a New Ride</h3>
            <form id="add-ride-form">
                <div>
                    <label for="ride-date">Date:</label>
                    <input type="date" id="ride-date" required>
                </div>
                <div>
                    <label for="ride-origin">Origin:</label>
                    <input type="text" id="ride-origin" placeholder="e.g., San Fernando" required>
                </div>
                <div>
                    <label for="ride-destination">Destination:</label>
                    <input type="text" id="ride-destination" placeholder="e.g., Port of Spain" required>
                </div>
                <div>
                    <label for="ride-fare">Fare (TTD):</label>
                    <input type="number" id="ride-fare" step="0.01" min="0" required>
                </div>
                <button type="submit">Add Ride</button>
            </form>
            
            <h3>My Rides</h3>
            <ul id="driver-rides-list" class="ride-list"></ul>
        </div>

        <div id="admin-dashboard-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Admin Dashboard</h2>
                <button onclick="logout()">Logout</button>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="showAdminSection('admin-drivers-section')">Manage Drivers</button>
                <button onclick="showAdminSection('admin-commissions-section')">Set Commissions</button>
                <button onclick="showAdminSection('admin-notes-section')">Update Notes</button>
                <button onclick="showAdminSection('leaderboard-section')">View Leaderboard</button>
            </div>
            
            <div id="admin-drivers-section" class="section active">
                <h3>All Drivers</h3>
                <ul id="admin-drivers-list" class="driver-list"></ul>
                
                <h3>Selected Driver Profile</h3>
                <div id="selected-driver-profile" style="display: none;">
                    <div id="admin-driver-info-display" class="driver-info">
                        <img id="admin-driver-picture" class="driver-picture" src="" alt="Driver Picture">
                        <div class="driver-info-details">
                            <p><strong>ID:</strong> <span id="admin-driver-id-display"></span></p>
                            <p><strong>Full Name:</strong> <span id="admin-full-name-display"></span></p>
                            <p><strong>WhatsApp Phone:</strong> <span id="admin-phone-display"></span></p>
                            <p><strong>Vehicle:</strong> <span id="admin-vehicle-type-color-display"></span></p>
                            <p><strong>License Plate:</strong> <span id="admin-license-plate-display"></span></p>
                            <p><strong>License Number:</strong> <span id="admin-license-number-display"></span></p>
                            <p><strong>Insurance Number:</strong> <span id="admin-insurance-number-display"></span></p>
                            <div class="vehicle-pictures">
                                <img id="admin-vehicle-picture" src="" alt="Vehicle Picture">
                                <img id="admin-insurance-picture" src="" alt="Insurance Picture">
                            </div>
                        </div>
                    </div>

                    <h4>Update Profile</h4>
                    <form id="admin-update-profile-form">
                        <div>
                            <label for="admin-set-full-name">Full Name:</label>
                            <input type="text" id="admin-set-full-name">
                        </div>
                        <div>
                            <label for="admin-set-whatsapp-phone">WhatsApp Phone:</label>
                            <input type="text" id="admin-set-whatsapp-phone">
                        </div>
                        <div>
                            <label for="admin-set-vehicle-type-color">Vehicle Type & Color:</label>
                            <input type="text" id="admin-set-vehicle-type-color">
                        </div>
                        <div>
                            <label for="admin-set-license-plate">License Plate:</label>
                            <input type="text" id="admin-set-license-plate">
                        </div>
                        <div>
                            <label for="admin-set-license-number">Driver's License Number:</label>
                            <input type="text" id="admin-set-license-number">
                        </div>
                        <div>
                            <label for="admin-set-insurance-number">Insurance Number:</label>
                            <input type="text" id="admin-set-insurance-number">
                        </div>
                        <button type="submit">Update Profile</button>
                    </form>

                    <h4>Add a Ride</h4>
                    <form id="admin-add-ride-form">
                        <div>
                            <label for="admin-add-ride-date">Date:</label>
                            <input type="date" id="admin-add-ride-date" required>
                        </div>
                        <div>
                            <label for="admin-add-ride-origin">Origin:</label>
                            <input type="text" id="admin-add-ride-origin" required>
                        </div>
                        <div>
                            <label for="admin-add-ride-destination">Destination:</label>
                            <input type="text" id="admin-add-ride-destination" required>
                        </div>
                        <div>
                            <label for="admin-add-ride-fare">Fare:</label>
                            <input type="number" id="admin-add-ride-fare" step="0.01" min="0" required>
                        </div>
                        <button type="submit">Add Ride</button>
                    </form>
                    
                    <h4>Rides</h4>
                    <ul id="admin-driver-rides-list" class="ride-list"></ul>
                </div>
            </div>

            <div id="admin-commissions-section" class="section">
                <h3>Set Driver Commissions</h3>
                <form id="set-commission-form">
                    <div>
                        <label for="select-driver-for-commissions">Select Driver:</label>
                        <select id="select-driver-for-commissions"></select>
                    </div>
                    <div>
                        <p><strong>Current Commission Due:</strong> <span id="admin-commission-amount">$0.00</span></p>
                        <p><strong>Current Due Date:</strong> <span id="admin-commission-due-date">N/A</span></p>
                    </div>
                    <div>
                        <label for="set-commission-amount">Set New Amount Due:</label>
                        <input type="number" id="set-commission-amount" step="0.01" min="0">
                    </div>
                    <div>
                        <label for="set-commission-due-date">Set New Due Date:</label>
                        <input type="date" id="set-commission-due-date">
                    </div>
                    <button type="submit">Set Commission</button>
                </form>
            </div>

            <div id="admin-notes-section" class="section">
                <h3>Driver Notes</h3>
                <form id="admin-update-notes-form">
                    <div>
                        <label for="admin-driver-notes">Notes for all drivers:</label>
                        <textarea id="admin-driver-notes" rows="6"></textarea>
                    </div>
                    <button type="submit">Update Notes</button>
                </form>
            </div>

            <div id="leaderboard-section" class="section">
                <h3>Leaderboard (Top 3 Drivers)</h3>
                <ul id="leaderboard-list" class="leaderboard-list"></ul>
            </div>
        </div>
    </div>

    <script>
        /* --- JavaScript Code Starts Here --- */
        // IMPORTANT: Replace this with the actual URL of your deployed Cloudflare Worker
        const API_URL = 'https://chanfana-openapi-template.blackcarpetridesharelogistics.workers.dev/';
        
        let loggedInDriverId = null;
        let isAdmin = false;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('#admin-dashboard-section .section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function logout() {
            loggedInDriverId = null;
            isAdmin = false;
            showSection('login-section');
            document.getElementById('login-form').reset();
        }

        // --- Core Application Logic ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('login-id').value;
            const userPassword = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId, password: userPassword })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.userType === 'admin') {
                        isAdmin = true;
                        await loadAdminDashboard();
                        showSection('admin-dashboard-section');
                    } else if (data.userType === 'driver') {
                        loggedInDriverId = data.driverId;
                        isAdmin = false;
                        await loadDriverDashboard();
                        showSection('driver-dashboard-section');
                    }
                } else {
                    alert(data.message || 'Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login. Please try again.');
            }
        });

        // --- Driver Functions ---
        async function loadDriverDashboard() {
            try {
                const response = await fetch(`${API_URL}/driver/${loggedInDriverId}/data`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const driver = data.driver;
                    // Update driver profile display
                    document.getElementById('driver-name-display').textContent = driver.full_name;
                    document.getElementById('driver-phone-display').textContent = driver.whatsapp_phone || 'N/A';
                    document.getElementById('vehicle-type-color-display').textContent = driver.vehicle_type_color || 'N/A';
                    document.getElementById('license-plate-display').textContent = driver.license_plate || 'N/A';
                    document.getElementById('license-number-display').textContent = driver.drivers_license_number || 'N/A';
                    document.getElementById('insurance-number-display').textContent = driver.insurance_number || 'N/A';
                    
                    document.getElementById('driver-picture-display').src = driver.driver_picture_url || 'https://via.placeholder.com/150?text=No+Image';
                    document.getElementById('vehicle-picture-display').src = driver.vehicle_picture_url || 'https://via.placeholder.com/100?text=No+Vehicle';
                    document.getElementById('insurance-picture-display').src = driver.insurance_picture_url || 'https://via.placeholder.com/100?text=No+Insurance';
                    
                    // Update commissions
                    document.getElementById('driver-commission-amount').textContent = `$${(driver.commission_due || 0).toFixed(2)}`;
                    document.getElementById('driver-commission-due-date').textContent = driver.commission_due_date || 'N/A';
                    
                    // Update rides list
                    const ridesList = document.getElementById('driver-rides-list');
                    ridesList.innerHTML = '';
                    if (driver.rides.length > 0) {
                        driver.rides.forEach(ride => {
                            const li = document.createElement('li');
                            li.textContent = `${ride.date}: ${ride.origin} to ${ride.destination} - $${ride.fare.toFixed(2)}`;
                            ridesList.appendChild(li);
                        });
                    } else {
                        ridesList.innerHTML = '<li>No rides recorded yet.</li>';
                    }

                    // Load admin notes
                    const notesResponse = await fetch(`${API_URL}/notes`);
                    const notesData = await notesResponse.json();
                    document.getElementById('driver-notes').textContent = notesData.notes || 'No notes from admin.';
                } else {
                    alert('Failed to load driver data: ' + data.message);
                    logout();
                }
            } catch (error) {
                console.error('Error loading driver dashboard:', error);
                alert('An error occurred while loading your data. Please try again.');
                logout();
            }
        }

        document.getElementById('add-ride-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('ride-date').value;
            const origin = document.getElementById('ride-origin').value;
            const destination = document.getElementById('ride-destination').value;
            const fare = parseFloat(document.getElementById('ride-fare').value);

            if (isNaN(fare) || fare < 0) {
                alert('Please enter a valid fare amount.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/driver/${loggedInDriverId}/ride`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, origin, destination, fare })
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Ride added successfully!');
                    document.getElementById('add-ride-form').reset();
                    await loadDriverDashboard();
                } else {
                    alert('Failed to add ride: ' + (data.message || response.statusText));
                }
            } catch (error) {
                console.error('Error adding ride:', error);
                alert('An error occurred while adding the ride. Please try again.');
            }
        });

        // --- Admin Functions ---
        async function loadAdminDashboard() {
            await loadAdminDrivers();
            await loadAdminNotes();
            await updateLeaderboard();
        }

        async function loadAdminDrivers() {
            try {
                const response = await fetch(`${API_URL}/admin/drivers`);
                const data = await response.json();

                if (response.ok && data.drivers) {
                    const driversList = document.getElementById('admin-drivers-list');
                    const commissionDriverSelect = document.getElementById('select-driver-for-commissions');
                    driversList.innerHTML = '';
                    commissionDriverSelect.innerHTML = '<option value="">Select a driver</option>';

                    data.drivers.forEach(driver => {
                        const li = document.createElement('li');
                        li.textContent = `${driver.full_name} (${driver.id}) - Rides: ${driver.total_rides}`;
                        const viewButton = document.createElement('button');
                        viewButton.textContent = 'View';
                        viewButton.classList.add('btn-link');
                        viewButton.onclick = () => loadSelectedDriverProfile(driver.id);
                        li.appendChild(viewButton);
                        driversList.appendChild(li);

                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.textContent = `${driver.full_name} (${driver.id})`;
                        commissionDriverSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading drivers:', error);
                alert('Failed to load driver list.');
            }
        }

        async function loadSelectedDriverProfile(driverId) {
            try {
                const response = await fetch(`${API_URL}/admin/driver/${driverId}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const driver = data.driver;
                    const profileSection = document.getElementById('selected-driver-profile');
                    profileSection.style.display = 'block';

                    // Update profile display
                    document.getElementById('admin-driver-id-display').textContent = driver.id;
                    document.getElementById('admin-full-name-display').textContent = driver.full_name || 'N/A';
                    document.getElementById('admin-phone-display').textContent = driver.whatsapp_phone || 'N/A';
                    document.getElementById('admin-vehicle-type-color-display').textContent = driver.vehicle_type_color || 'N/A';
                    document.getElementById('admin-license-plate-display').textContent = driver.license_plate || 'N/A';
                    document.getElementById('admin-license-number-display').textContent = driver.drivers_license_number || 'N/A';
                    document.getElementById('admin-insurance-number-display').textContent = driver.insurance_number || 'N/A';
                    
                    document.getElementById('admin-driver-picture').src = driver.driver_picture_url || 'https://via.placeholder.com/150?text=No+Image';
                    document.getElementById('admin-vehicle-picture').src = driver.vehicle_picture_url || 'https://via.placeholder.com/100?text=No+Vehicle';
                    document.getElementById('admin-insurance-picture').src = driver.insurance_picture_url || 'https://via.placeholder.com/100?text=No+Insurance';

                    // Set form values for easy editing
                    document.getElementById('admin-set-full-name').value = driver.full_name || '';
                    document.getElementById('admin-set-whatsapp-phone').value = driver.whatsapp_phone || '';
                    document.getElementById('admin-set-vehicle-type-color').value = driver.vehicle_type_color || '';
                    document.getElementById('admin-set-license-plate').value = driver.license_plate || '';
                    document.getElementById('admin-set-license-number').value = driver.drivers_license_number || '';
                    document.getElementById('admin-set-insurance-number').value = driver.insurance_number || '';

                    // Update rides list for the driver
                    const ridesList = document.getElementById('admin-driver-rides-list');
                    ridesList.innerHTML = '';
                    if (driver.rides.length > 0) {
                        driver.rides.forEach(ride => {
                            const li = document.createElement('li');
                            li.textContent = `${ride.date}: ${ride.origin} to ${ride.destination} - $${ride.fare.toFixed(2)}`;
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = () => deleteRide(ride.id, driverId);
                            li.appendChild(deleteButton);
                            ridesList.appendChild(li);
                        });
                    } else {
                        ridesList.innerHTML = '<li>No rides recorded yet.</li>';
                    }

                } else {
                    alert('Failed to load driver profile: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading driver profile:', error);
                alert('An error occurred while loading the driver profile.');
            }
        }

        async function deleteRide(rideId, driverId) {
            if (!confirm('Are you sure you want to delete this ride?')) return;
            try {
                const response = await fetch(`${API_URL}/admin/ride/${rideId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Ride deleted successfully!');
                    loadSelectedDriverProfile(driverId);
                } else {
                    alert('Failed to delete ride: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting ride:', error);
                alert('An error occurred while deleting the ride.');
            }
        }

        document.getElementById('admin-update-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const driverId = document.getElementById('admin-driver-id-display').textContent;
            const fullName = document.getElementById('admin-set-full-name').value;
            const whatsappPhone = document.getElementById('admin-set-whatsapp-phone').value;
            const vehicleTypeColor = document.getElementById('admin-set-vehicle-type-color').value;
            const licensePlate = document.getElementById('admin-set-license-plate').value;
            const driversLicenseNumber = document.getElementById('admin-set-license-number').value;
            const insuranceNumber = document.getElementById('admin-set-insurance-number').value;

            try {
                const response = await fetch(`${API_URL}/admin/driver/${driverId}/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fullName, whatsappPhone, vehicleTypeColor, licensePlate, driversLicenseNumber, insuranceNumber })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Driver profile updated successfully!');
                    loadSelectedDriverProfile(driverId);
                    loadAdminDrivers(); // Refresh main list
                } else {
                    alert('Failed to update profile: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('An error occurred while updating the profile.');
            }
        });

        document.getElementById('admin-add-ride-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const driverId = document.getElementById('admin-driver-id-display').textContent;
            const date = document.getElementById('admin-add-ride-date').value;
            const origin = document.getElementById('admin-add-ride-origin').value;
            const destination = document.getElementById('admin-add-ride-destination').value;
            const fare = parseFloat(document.getElementById('admin-add-ride-fare').value);

            if (isNaN(fare) || fare < 0) {
                alert('Please enter a valid fare amount.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/driver/${driverId}/ride`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, origin, destination, fare })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Ride added successfully!');
                    document.getElementById('admin-add-ride-form').reset();
                    loadSelectedDriverProfile(driverId);
                    loadAdminDrivers(); // Refresh main list
                } else {
                    alert('Failed to add ride: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding ride:', error);
                alert('An error occurred while adding the ride.');
            }
        });

        document.getElementById('select-driver-for-commissions').addEventListener('change', loadCommissionsForAdmin);

        async function loadCommissionsForAdmin() {
            const selectedDriverId = document.getElementById('select-driver-for-commissions').value;
            if (!selectedDriverId) {
                document.getElementById('admin-commission-amount').textContent = '$0.00';
                document.getElementById('admin-commission-due-date').textContent = 'N/A';
                document.getElementById('set-commission-amount').value = '';
                document.getElementById('set-commission-due-date').value = '';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/admin/driver/${selectedDriverId}`);
                const data = await response.json();
                if (response.ok && data.success) {
                    const driver = data.driver;
                    document.getElementById('admin-commission-amount').textContent = `$${(driver.commission_due || 0).toFixed(2)}`;
                    document.getElementById('admin-commission-due-date').textContent = driver.commission_due_date || 'N/A';
                    document.getElementById('set-commission-amount').value = driver.commission_due || '';
                    document.getElementById('set-commission-due-date').value = driver.commission_due_date || '';
                }
            } catch (error) {
                console.error('Error loading commissions:', error);
                alert('An error occurred while loading commission data.');
            }
        }

        document.getElementById('set-commission-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedDriverId = document.getElementById('select-driver-for-commissions').value;
            if (!selectedDriverId) {
                alert('Please select a driver to set commission for.');
                return;
            }

            const commissionDue = parseFloat(document.getElementById('set-commission-amount').value);
            const commissionDueDate = document.getElementById('set-commission-due-date').value;

            if (isNaN(commissionDue) || commissionDue < 0) {
                alert('Please enter a valid non-negative commission amount.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/driver/${selectedDriverId}/commission`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commissionDue, commissionDueDate })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Commission updated successfully!');
                    loadCommissionsForAdmin();
                } else {
                    alert('Failed to update commission: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating commission:', error);
                alert('An error occurred while updating the commission.');
            }
        });

        async function loadAdminNotes() {
            try {
                const response = await fetch(`${API_URL}/notes`);
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('admin-driver-notes').value = data.notes || '';
                }
            } catch (error) {
                console.error('Error loading admin notes:', error);
            }
        }

        document.getElementById('admin-update-notes-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const notes = document.getElementById('admin-driver-notes').value.trim();
            try {
                const response = await fetch(`${API_URL}/admin/notes`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Driver notes updated successfully!');
                    // Optionally, update the driver dashboard notes if the admin is viewing it
                } else {
                    alert('Failed to update notes: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                alert('An error occurred while updating the notes.');
            }
        });

        async function updateLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/leaderboard`);
                const data = await response.json();
                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = '';
                if (response.ok && data.success && data.leaderboard) {
                    if (data.leaderboard.length > 0) {
                        data.leaderboard.forEach((driver, index) => {
                            const li = document.createElement('li');
                            li.textContent = `${index + 1}. ${driver.full_name} - Rides: ${driver.ride_count}`;
                            leaderboardList.appendChild(li);
                        });
                    } else {
                        leaderboardList.innerHTML = '<li>No ride data available.</li>';
                    }
                } else {
                    leaderboardList.innerHTML = '<li>Failed to load leaderboard.</li>';
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboard-list').innerHTML = '<li>An error occurred.</li>';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('login-section');
        });
        /* --- JavaScript Code Ends Here --- */
    </script>
</body>
</html>
